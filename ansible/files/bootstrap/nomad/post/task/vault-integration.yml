- name: Set variables
  set_fact:
    nomad:
      policy:
        producer: "producer-policy"
        consumer: "consumer-policy"

- name: "{{ service }} - post/vault-integration - fetch bootstrap token nomad"
  shell:
    cmd: vault kv get -field=bootstrap-token-secret-id secret/nomad-token-example
  register: bootstrap_token
  environment:
    VAULT_TOKEN: "{{ lookup('env', 'vault_master_token') }}"


- name: "{{ service }} - post/vault-integration -  Create management token for vault"
  shell:
    cmd: nomad acl token create -name="Vault Management Token" -type="management" > management.token
  environment:
    NOMAD_TOKEN: "{{ bootstrap_token.stdout }}"

- name: "{{ service }} - post/vault-integration - register accessor ID"
  shell:
    cmd: awk '/Accessor/ {print $4}' management.token
  register: accessor_id

- name: "{{ service }} - post/vault-integration - register secret ID"
  shell:
    cmd: awk '/Secret/ {print $4}' management.token
  register: secret_id

- name: "{{ service }} - post/vault-integration - add nomad management token to vault"
  shell:
    cmd: vault kv put secret/nomad-token-example management-accessor-id="{{ accessor_id.stdout }}" management-secret-id="{{ secret_id.stdout }}"
  environment:
    VAULT_TOKEN: "{{ lookup('env', 'vault_master_token') }}"

- name: "{{ service }} - post/vault-integration - delete management.token file"
  file:
    path: management.token
    state: absent

- name: "{{ service }} - post/vault-integration - write vault's nomad config"
  shell:
    cmd: vault write nomad/config/access address=http://127.0.0.1:4646 token="{{ secret_id.stdout }}"
  register: result
  environment:
    VAULT_TOKEN: "{{ lookup('env', 'vault_master_token') }}"

- name: "{{ service }} - post/vault-integration - map role consumer with nomad's consumer-policy"
  shell: vault write nomad/role/consumer policies={{ consul.policy.consumer }}
  environment:
    VAULT_TOKEN: "{{ lookup('env', 'vault_master_token') }}"

- name: "{{ service }} - post/vault-integration - map role producer with nomad's consumer-policy"
  shell:
    cmd: vault write nomad/role/producer policies={{ consul.policy.producer }}
  environment:
    VAULT_TOKEN: "{{ lookup('env', 'vault_master_token') }}"
