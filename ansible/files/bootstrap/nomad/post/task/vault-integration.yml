- name: Set variables
  set_fact:
    nomad:
      policy:
        producer: "producer-policy"
        consumer: "consumer-policy"

# Bootstrap and management tokens
- name: "{{ service }} - post/vault-integration - fetch bootstrap token nomad"
  shell:
    cmd: vault kv get -field=bootstrap-token-secret-id secret/nomad-token-example
  register: bootstrap_token
  environment:
    VAULT_TOKEN: "{{ lookup('env', 'vault_master_token') }}"

- name: "{{ service }} - post/vault-integration -  Create management token for vault"
  shell:
    cmd: nomad acl token create -name="Vault Management Token" -type="management" > management.token
  environment:
    NOMAD_TOKEN: "{{ bootstrap_token.stdout }}"

- name: "{{ service }} - post/vault-integration - register accessor ID"
  shell:
    cmd: awk '/Accessor/ {print $4}' management.token
  register: management_accessor_id

- name: "{{ service }} - post/vault-integration - register secret ID"
  shell:
    cmd: awk '/Secret/ {print $4}' management.token
  register: management_secret_id

- name: "{{ service }} - post/vault-integration - add nomad management token to vault"
  shell:
    cmd: vault kv put secret/nomad-token-example bootstrap_token="{{ bootstrap_token.stdout }}" management-accessor-id="{{ management_accessor_id.stdout }}" management-secret-id="{{ management_secret_id.stdout }}"
  environment:
    VAULT_TOKEN: "{{ lookup('env', 'vault_master_token') }}"

- name: "{{ service }} - post/vault-integration - delete management.token file"
  file:
    path: management.token
    state: absent

- name: "{{ service }} - post/vault-integration - write vault's nomad config"
  shell:
    cmd: vault write nomad/config/access address=http://127.0.0.1:4646 token="{{ secret_id.stdout }}"
  register: result
  environment:
    VAULT_TOKEN: "{{ lookup('env', 'vault_master_token') }}"

# Map roles
- name: "{{ service }} - post/vault-integration - map role consumer with nomad's consumer-policy"
  shell: vault write nomad/role/consumer policies={{ nomad.policy.consumer }}
  environment:
    VAULT_TOKEN: "{{ lookup('env', 'vault_master_token') }}"

- name: "{{ service }} - post/vault-integration - map role producer with nomad's consumer-policy"
  shell: vault write nomad/role/producer policies={{ nomad.policy.producer }}
  environment:
    VAULT_TOKEN: "{{ lookup('env', 'vault_master_token') }}"

# todo remove later: template depends on write role (write role associated with produce role)
# https://github.com/fredrikhgrelland/vagrant-hashistack-template/issues/58
- name: "{{ service }} - post/vault-integration - map role `write` with nomad's consumer-policy"
  shell: vault write nomad/role/write policies={{ nomad.policy.producer }}
  environment:
    VAULT_TOKEN: "{{ lookup('env', 'vault_master_token') }}"

# Generate tokens
- name: "{{ service }} - post/vault-integration - example, generate token for role consumer"
  shell: vault read nomad/creds/consumer-role -format=json | jq -r .data.token
  register: consumer_nomad_role_token
  environment:
    VAULT_TOKEN: "{{ lookup('env', 'vault_master_token') }}"

- name: "{{ service }} - post/vault-integration - example, generate token for role producer"
  shell: vault read nomad/creds/producer-role -format=json | jq -r .data.token
  register: producer_nomad_role_token
  environment:
    VAULT_TOKEN: "{{ lookup('env', 'vault_master_token') }}"

#######################
### Put tokens generated by vault for consul in vault K/V
#######################
- name: Vault - put generated tokens in k/v as examples
  shell: vault kv put secret/nomad-token-example producer_token="{{ producer_nomad_role_token.stdout }}" consumer_token="{{ consumer_nomad_role_token.stdout }}"
  environment:
    VAULT_TOKEN: "{{ lookup('env', 'vault_master_token') }}"

#######################
### tokens will be used in tests
#######################
- set_fact:
    nomad:
      vault:
        acl:
          admin_token: "{{ management_secret_id.stdout }}"
          producer_token: "{{ producer_nomad_role_token.stdout }}"
          consumer_token: "{{ consumer_nomad_role_token.stdout }}"
