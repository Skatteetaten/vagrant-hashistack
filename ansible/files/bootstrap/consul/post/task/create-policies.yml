- name: Set variables
  set_fact:
    consul_master_token: "master"
    consul:
      acl:
        admin_token: ""
        producer_token: ""
        consumer_token: ""
      policy:
        admin: "admin-policy"
        producer: "producer-policy"
        consumer: "consumer-policy"

#######################
### CREATE policies
#######################
- name: Consul - create admin team policy
  shell: consul acl policy create -name {{ consul.policy.admin }} -rules @/etc/ansible/templates/conf/consul/policies/admin_policy.hcl
  environment:
    CONSUL_HTTP_TOKEN: "{{ consul_master_token }}"
- name: Consul - create producer team policy
  shell:
    cmd: consul acl policy create -name {{ consul.policy.producer }} -rules @/etc/ansible/templates/conf/consul/policies/producer_policy.hcl
  environment:
    CONSUL_HTTP_TOKEN: "{{ consul_master_token }}"
- name: Consul - create consumer team policy
  shell:
    cmd: consul acl policy create -name {{ consul.policy.consumer }} -rules @/etc/ansible/templates/conf/consul/policies/consumer_policy.hcl
  environment:
    CONSUL_HTTP_TOKEN: "{{ consul_master_token }}"

#######################
### GENERATE tokens
#######################
- name: Generate admin token - with master token
  shell: consul acl token create -description="Admin token" -policy-name={{ consul.policy.admin }} -format=json | jq -r .SecretID
  register: admin_token
  environment:
    CONSUL_HTTP_TOKEN: "{{ consul_master_token }}"

- name: Debug
  debug:
    msg: "Debug {{ admin_token }}"

- name: Generate producer token - with admin_token
  shell: consul acl token create -description="Producer token" -policy-name={{ consul.policy.producer }} -format=json | jq -r .SecretID
  register: producer_token
  environment:
    CONSUL_HTTP_TOKEN: "{{ admin_token.stdout }}"

- name: Generate consumer token - with admin_token
  shell: consul acl token create -description="Consumer token" -policy-name={{ consul.policy.consumer }} -format=json | jq -r .SecretID
  register: consumer_token
  environment:
    CONSUL_HTTP_TOKEN: "{{ admin_token.stdout }}"


#######################
### Put generated tokens in consul K/V
#######################
- name: Consul - put generated tokens in k/v as examples
  shell: consul kv put secret/consul-token-example admin_token="{{ admin_token.stdout }}" producer_token="{{ producer_token.stdout }}" consumer_token="{{ consumer_token.stdout }}"

#######################
### tokens generated by consul -> consul.acl.<token-name>
#######################
- set_fact:
    consul:
      acl:
        admin_token: "{{ admin_token.stdout }}"
        producer_token: "{{ producer_token.stdout }}"
        consumer_token: "{{ consumer_token.stdout }}"

#######################
### tokens will be used in tests
#######################
- set_fact:
    admin_token: "{{ admin_token.stdout }}"
    producer_token: "{{ producer_token.stdout }}"
    consumer_token: "{{ consumer_token.stdout }}"
