---
- hosts: all
  become: yes
  tasks:
    - name: acl bootstrap nomad
      shell:
        cmd: (nomad acl bootstrap > management.token) && awk '/Secret/ {print $4}' management.token
      register: management_token

    - name: print management token
      debug:
        msg: "{{ management_token.stdout }}"

    - name: try without token
      shell:
        cmd: nomad job status
      register: without_token
      failed_when:
        - "'Permission denied' not in without_token.stderr"

    - name: try with token
      shell:
        cmd: nomad job status -token "{{ management_token.stdout }}"
#
    - name: create policy write
      shell:
        cmd: nomad acl policy apply -token {{ management_token.stdout }} -description "Test write policy" write-test write.policy.hcl
#
    - name: create policy read
      shell:
        cmd: nomad acl policy apply -token {{ management_token.stdout }} -description "Test read policy" read-test read.policy.hcl

    - name: create read token
      shell:
        cmd: (nomad acl token create -token {{ management_token.stdout }} -name="Test read token" -policy=read-test -type=client > read-test.token) && awk '/Secret/ {print $4}' read-test.token
      register: read_token

    - name: print read token
      debug:
        msg: "{{ read_token.stdout }}"

    - name: create write token
      shell:
        cmd: (nomad acl token create -token {{ management_token.stdout }} -name="Test write token" -policy=write-test -type=client > write-test.token) && awk '/Secret/ {print $4}' write-test.token
      register: write_token

    - name: print write token
      debug:
        msg: "{{ write_token.stdout }}"

    - name: run job with read token
      shell:
        cmd: nomad job run -token {{ read_token.stdout }} ../nomad/nginx.hcl
      register: with_read_token
      failed_when:
        - "'Permission denied' not in with_read_token.stderr"

    - name: run job with write token
      shell:
        cmd: nomad job run -token {{ write_token.stdout }} ../nomad/nginx.hcl
      register: with_write_token

    - name: check status with read token
      shell:
        cmd: nomad job status -token {{ read_token.stdout }} nginx
      register: with_read_token

    - name: remove tmp-files
      shell:
        cmd: rm -f read-test.token write-test.token management.token

#    - name: Terraform
#      terraform:
#        project_path: ../terraform
#        force_init: true
#        state: present
#      register: terraform
#
#    - name: Terraform stdout
#      debug:
#        msg: "{{terraform.stdout}}"